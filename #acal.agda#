module acal where

open import lib
open import aggycal-types

aDate : Set
aDate = year Ã— month Ã— day

aTime : Set
aTime = hour Ã— minute

aTimeRange : Set
aTimeRange = aTime Ã— aTime

data acal : Set where
  evt :  words {- event name -} â†’
         aDate {- event date -} â†’
         aTimeRange {- event start and end times -} â†’
         words {- description -} â†’
         acal

  xf

{- used for testing purposes -}
acal-to-string : acal â†’ string
acal-to-string (evt name (year , month , day) ((sHour , sMin) , (eHour , eMin)) description) = 
  "Event Name: " ^ name ^
  "\nDate: " ^ year ^ "/" ^ month ^ "/" ^ day ^
  "\nStart Time: " ^ sHour ^ ":" ^ sMin ^
  "\nEnd Time: " ^ eHour ^ ":" ^ eMin ^
  "\nDescription: " ^ description














format-nodes-for-gv : ğ•ƒ string â†’ mg â†’ string
format-nodes-for-gv [] mg = ""
format-nodes-for-gv (x :: l) mg = (format-node-for-gv x mg) ^ (format-nodes-for-gv l mg)

mg-to-gv-h : ğ•ƒ (string Ã— ğ•ƒ string) â†’ mg â†’ string
mg-to-gv-h [] mg = ""
mg-to-gv-h ((parent , children) :: l) mg =
  (format-node-for-gv parent mg) ^ (format-nodes-for-gv children mg) ^
  parent ^ " -> { " ^ (string-concat-sep " " children) ^ "};\n" ^
  (mg-to-gv-h l mg)

format-roots-for-gv : ğ•ƒ string â†’ â„• â†’ string
format-roots-for-gv [] n = ""
format-roots-for-gv (x :: l) n =
  "hidden" ^ â„•-to-string n ^ " [shape = plaintext , label = \"\"];hidden" ^ â„•-to-string n ^ " -> " ^ x ^ "\n" ^
  format-roots-for-gv l (suc n)

mg-to-gv : mg â†’ string
mg-to-gv (mkmg roots marked next graph) =
  "digraph mem {\n" ^
  mg-to-gv-h (trie-mappings graph) (mkmg roots marked next graph) ^
  format-roots-for-gv roots zero ^
  "}"

mg-to-string : ğ”¹ â†’  mg â†’ string
mg-to-string tt = mg-to-string-simple
mg-to-string ff = mg-to-gv

remove-nodes : ğ•ƒ (string Ã— ğ•ƒ string) â†’ mg â†’ mg
remove-nodes [] mg = mg
remove-nodes ((parent , _) :: l) (mkmg roots marked next graph) with stringset-contains marked parent
... | tt = remove-nodes l (mkmg roots marked next graph)
... | ff = remove-nodes l (mkmg roots marked next (trie-remove graph parent))

collect-garbage : mg â†’ mg
collect-garbage (mkmg roots marked next graph) = remove-nodes (trie-mappings graph) (mkmg roots marked next graph)

{-# NON_TERMINATING #-}
traverse : ğ•ƒ string â†’ mg â†’ ğ”¹ â†’ ğ•ƒ string
traverse l (mkmg r m (n :: t) g) gv with stringset-contains m n
... | ff = let newState = (mkmg r (stringset-insert m n) (t ++ (ğ•ƒtrie-lookup g n)) g) in
             traverse (l ++ [ mg-to-string gv (mkmg r m (n :: t) g) ]) newState gv
... | tt = traverse (l ++ [ mg-to-string gv (mkmg r m (n :: t) g) ]) (mkmg r m t g) gv
traverse l mg gv = l ++ [ mg-to-string gv mg ] ++ [ mg-to-string gv (collect-garbage mg) ]

generate-traversal : mg â†’ ğ•ƒ string
generate-traversal mg = traverse [] mg ff -- tt for simple version, ff for gv
-}
